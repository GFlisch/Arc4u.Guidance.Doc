May 2019.
# Guidance 2017.1.15-0

This new version fix a lot of small issues from version 2017.1.14-2 and runs on Visual Studio 2017 and 2019.
</br>
But also 2 new features:
- NServiceBus integration.
- VueJS.

## What about the new features?

### Messaging.

You can now add a messaging project to the backend and allow communication to a borker messages platform. Today only RabbitMQ is supported.

The servicebus in Azure will be supported too.

> Todo: Add video and explanation here.

---
### VueJS.

[VueJs](https://vuejs.org/) is a light and efficient javascript UI framework and it will be used until blazor.net is mature and released to build web frontends.

The guidance will create a physical folder structure with all the npm packages, config, layout and typescript code to build a basic UI.

The Arc4u framework to authenticate the user is based on adal.js via the package adal-angular. Updates of the framework package will come from npm store.

The same for the design (electron-design) wich is also a npm package.

The name of the UI will be the name of the folder below the FE folder in the solution.

[![Everything Is AWESOME](https://img.youtube.com/vi/f_dJSNeELgE/2.jpg)](https://youtu.be/f_dJSNeELgE "Arc4u Guidance - VueJS.")

At the level of Visual Studio, there is no project but only Solution folders and files. Visual Studio code is the tool after to develop and debug the VueJS app.

[![Everything Is AWESOME](https://img.youtube.com/vi/HZaWYQ-Yykc/1.jpg)](https://youtu.be/HZaWYQ-Yykc "Arc4u Guidance - VueJS.")

What's Generate?

```

Configs     => OAuth config files by environment.
public      => result of the build to deploy.
src         => The Vue application.

Files used to configure the edition and compilation.

.vscode
.editorconfig
.gitignore
babel.config.js
package.json
README.md
tsconfig.json
```

To start the application after the generation, execute:
- yarn install
- yarn run serve

The result is:

[![Everything Is AWESOME](https://img.youtube.com/vi/2NYRsqc4OZ4/1.jpg)](https://youtu.be/2NYRsqc4OZ4 "Arc4u Guidance - VueJS.")

The code below the src folder is organized like this.

```
 assets         => images.
 proxy          => NSwag typescript code generated to call the backend.
 views          => Vue pages.
 Access.ts      => Class defining the rights.
 App.vue        => Main page with the skeleton layout.
 GlobalResource.ts  => the string localized.
 main.ts        => Authenticate the user and start Vue.
 registerServiceWorker.ts
 router.ts      => Define the routes when surfing on a page.
 shims-tsx.d.ts
 shims-vue.d.ts
 store.ts
 tokenConfig.json   => the config to connect AzureAD or ADFS server.
```
The Access class is not yet generated by Guidance.

The main.ts class is the first code accessed when starting the application. What this code will do is authenticate you to AzureAD or ADFS 2016.

If the authentication succeeds, the application will show the pages you have access, if not the unAuthorized page is shown.

```typescript
import Vue from "vue";
import { i18n } from "@/GlobalResource";
// @ts-ignore
import colors from "vuetify/es5/util/colors";
// @ts-ignore
import Vuetify from "vuetify/lib";
import App from "./App.vue";
import router from "./router";
import store from "./store";

import AppSettings from "../node_modules/arc4u.framework.js/token/AppSettings";
import IAppSettings from "../node_modules/arc4u.framework.js/token/IAppSettings";
import ITokenProvider from "../node_modules/arc4u.framework.js/token/ITokenProvider";
import TokenProviderFactory from "../node_modules/arc4u.framework.js/token/TokenProviderFactory";
import config from "@/tokenConfig.json";
import CreatePrincipal from "../node_modules/arc4u.framework.js/Security/AppPrincipalFactory";
import ClaimsTokenFiller from "../node_modules/arc4u.framework.js/Security/Principal/ClaimsProxy";
import ClaimsProfileFiller from "../node_modules/arc4u.framework.js/Security/Principal/ClaimsProfileFiller";
import ClaimsAuthorizationFiller from "../node_modules/arc4u.framework.js/Security/Principal/ClaimsAuthorizationFiller";
import ApplicationContext from "../node_modules/arc4u.framework.js/Security/Principal/ApplicationContext";
...
CreatePrincipal.ClaimsFiller = new ClaimsTokenFiller();
CreatePrincipal.UserProfileFiller = new ClaimsProfileFiller();
CreatePrincipal.AuthorizationFiller = new ClaimsAuthorizationFiller();


const settings: IAppSettings = new AppSettings();
settings.Initialize("OAuth", config);
let tokenProvider: ITokenProvider | undefined = TokenProviderFactory.GetProvider("OAuth");
if (tokenProvider) {
  tokenProvider.GetTokenAsync(true).then(tokenInfo => {
    new CreatePrincipal().CreatePrincipal("OAuth")
      .then((principal) => {
        ApplicationContext.Current = principal;
        callback();
      });
  }).catch(() => {
    callback();
  });
}
```
First, we import the Arc4u javascript framework to create the principal.

The CreatePrincipal class is a flexible class where you can add your own code to build a principal:

- ClaimsFiller is a way to add claims or extract them from the bearer token.
- UserProfileFiller will create the UserProfile class of the principal.
- AuthorizationFiller will extract from the claims the rights and build the authorization of the principal.

The AppSettings class read the config (from the json file) and you can have more than one (in case you have to contact more than one backend) even if this is not the purpose.

The TokenProvider is the class that will launch adal.js and authenticate you. In case you have a token, the principal is created and the global ApplicationContext.Current principal is set.

The callback function launches the VueJS application!

#### Facade Sdk

To generate the typescript code a [NSwag](https://github.com/RicoSuter/NSwag) file is added to the generator folder of the facadeSdk project. This added NSwag contains a reference to a template file (in the VueJS project). The template contains the code NSwag will use to inject the bearer token during the request to the services.

With the code generated we have the same experience than with the .Net client Sdk generated but in typescript.


---

## What are changed or fixed?

- Create principal based on a encrypted user name and password.
  - Hangfire code is adapted.
  - NServiceBus handler uses also this principal.
  > It is important to create a principal and a OAuth token so when in the code you test the right of a user or you call a backend you have a principal and a bearer token.

- Hangfire project created an extra folder not needed.
- ADFS Folder is now centralized in one place for all the small services created on the solution.
  > Centralisation of the registration will ease the ADFS and AzureAD registration.
- Localhost string was not in lowercase for the ADFS registration.


